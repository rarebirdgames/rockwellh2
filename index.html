<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rockwell H2</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="brand" href="/">Rockwell H2</a>
        <nav class="nav">
          <a href="/admin/">Admin</a>
        </nav>
      </div>
    </header>

    <main class="container">
      <h1 id="page-title">Loading...</h1>
      <div id="page-body" class="prose"></div>
    </main>

    <footer class="site-footer">
      <div class="container">
        <small>Deployed on Netlify, edited with Decap CMS.</small>
      </div>
    </footer>

    <!-- Markdown renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
      // Optional: after Identity login, return to /admin/
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", (user) => {
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              document.location.href = "/admin/";
            });
          }
        });
      }

      function parseFrontMatter(md) {
        const trimmed = md.replace(/^\uFEFF/, "");
        if (!trimmed.startsWith("---")) return { data: {}, body: trimmed };
        const end = trimmed.indexOf("\n---", 3);
        if (end === -1) return { data: {}, body: trimmed };
        const fmBlock = trimmed.slice(3, end).trim();
        const body = trimmed.slice(end + 4).trim();
        const data = {};
        for (const line of fmBlock.split(/\r?\n/)) {
          const m = line.match(/^\s*([A-Za-z0-9_\-]+)\s*:\s*(.*)\s*$/);
          if (m) data[m[1]] = m[2].replace(/^"|"$/g, "");
        }
        return { data, body };
      }

      async function loadHome() {
        const res = await fetch("/content/home.md", { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to load content/home.md");
        const md = await res.text();
        const { data, body } = parseFrontMatter(md);

        document.getElementById("page-title").textContent = data.title || "Home";
        document.getElementById("page-body").innerHTML = marked.parse(body);
      }

      loadHome().catch((err) => {
        document.getElementById("page-title").textContent = "Content not found";
        document.getElementById("page-body").textContent =
          "Make sure content/home.md exists in the repo and is deployed.";
        console.error(err);
      });
    </script>
  </body>
</html>
